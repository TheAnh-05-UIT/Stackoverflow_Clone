
# user  nginx;
# worker_processes  auto;

# error_log  /var/log/nginx/error.log notice;
# pid        /var/run/nginx.pid;


# events {
#     worker_connections  1024;
# }

# http {

#    include       /etc/nginx/mime.types;

#     upstream backend-stackoverflow {
#         server backend:8000;
#     }

#     server {
#         listen       80;
#         listen  [::]:80;

#         # error_page 404             /404.html;

#         # location  /404.html {
#         #      root   /usr/share/nginx/html;
#         # }

#         location / {
#             root   /usr/share/nginx/html;
#             index  index.html index.htm;
#             try_files $uri /index.html;
#         }

#         location /api {
#             proxy_pass http://backend-stackoverflow;
#         }

#     }
# }


# --- XÓA HẾT CÁI CŨ, DÁN CÁI NÀY VÀO ---

# Định nghĩa nhóm server backend
upstream backend-stackoverflow {
    # 'backend' là tên service trong docker-compose
    server backend:8000;
}

server {
    listen 80;
    listen [::]:80;
    server_name localhost;

    # Cấu hình cho ReactJS (Frontend)
    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
        # Dòng này giúp React Router không bị lỗi 404 khi F5
        try_files $uri $uri/ /index.html;
    }

    # Cấu hình gọi API (Backend)
    location /api {
        # Dùng tên upstream đã định nghĩa ở trên
        proxy_pass http://backend-stackoverflow;
        
        # Các header cần thiết để Backend nhận diện đúng Client
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}