# # https://docs.docker.com/compose/compose-file/compose-versioning/#compatibility-matrix
# # => run: docker version để biết enginer version bao nhiêu
# # version: "3.9"
# services:
#     nginx:
#         container_name: my-nginx
#         depends_on:
#             - backend
#         restart: always # because it is routing traffic to our entire app
#         build:
#             context: .
#             dockerfile: ./nginx/Dockerfile
#         ports:
#             - 8001:80

#         volumes:
#             # - ./nginx/config/nginx.conf:/etc/nginx/nginx.conf
#             - ./nginx/config/default.conf:/etc/nginx/conf.d/default.conf

#     mysqldb:
#         image: mysql:5.7
#         restart: unless-stopped
#         container_name: my-db
#         command: --init-file /data/application/init.sql
#         volumes:
#             - ./initDB.sql:/data/application/init.sql
#         environment:
#             # - MYSQL_USER=root => root user created automatically
#             - MYSQL_ROOT_PASSWORD=123456
#             - MYSQL_DATABASE=stack_overflow
#         ports:
#             - 3307:3306

#     backend:
#         depends_on:
#             - mysqldb
#         restart: unless-stopped
#         container_name: my-backend
#         build:
#             context: ./stackBE
#         # environment:
#         #     - DATABASE_PORT=3307
#         #     - HOST=host.docker.internal
#         environment:
#             - DATABASE_PORT=3306 # bên trong container
#             - HOST=mysqldb # tên service MySQL
#         ports:
#             - 8000:8000

# version: "3.9"
# services:
#     nginx:
#         container_name: my-nginx
#         depends_on:
#             - backend
#         restart: always
#         build:
#             context: .
#             dockerfile: ./nginx/Dockerfile
#         ports:
#             - 8001:80
#         volumes:
#             - ./nginx/config/default.conf:/etc/nginx/conf.d/default.conf

#     mysqldb:
#         image: mysql:5.7
#         container_name: my-db
#         restart: unless-stopped
#         command: --init-file /data/application/init.sql
#         volumes:
#             - ./initDB.sql:/data/application/init.sql
#         environment:
#             - MYSQL_ROOT_PASSWORD=123456
#             - MYSQL_DATABASE=stack_overflow
#         ports:
#             - 3307:3306
#         healthcheck:
#             test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
#             interval: 5s
#             timeout: 3s
#             retries: 10

#     backend:
#         container_name: my-backend
#         build:
#             context: ./stackBE
#         environment:
#             - DATABASE_PORT=3306
#             - HOST=mysqldb
#         ports:
#             - 8000:8000
#         depends_on:
#             mysqldb:
#                 condition: service_healthy
# docker compose -p nhom22 up -d
# docker exec -it my-db mysql -u root -p

# version: "3.9"

# services:
#     mysqldb:
#         image: mysql:5.7
#         container_name: my-db
#         restart: unless-stopped
#         command: --init-file /data/application/init.sql
#         volumes:
#             - ./initDB.sql:/data/application/init.sql
#         environment:
#             MYSQL_ROOT_PASSWORD: 123456
#             MYSQL_DATABASE: stack_overflow
#         ports:
#             - "3307:3306" # expose đúng port MySQL mặc định
#         healthcheck:
#             test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
#             interval: 5s
#             timeout: 3s
#             retries: 10

#     backend:
#         container_name: my-backend
#         build:
#             context: ./stackBE
#         environment:
#             HOST: mysqldb # tên service MySQL trong Docker network
#             DATABASE_PORT: 3306 # port MySQL bên trong container
#             DATABASE: stack_overflow
#             USER: root
#             PASSWORD: 123456
#         ports:
#             - "8000:8000"
#         depends_on:
#             mysqldb:
#                 condition: service_healthy

#     nginx:
#         container_name: my-nginx
#         build:
#             context: .
#             dockerfile: ./nginx/Dockerfile
#         depends_on:
#             - backend
#         restart: always
#         ports:
#             - "8001:80"
#         volumes:
#             - ./nginx/config/default.conf:/etc/nginx/conf.d/default.conf

# version: "3.9"

# services:
#     mysqldb:
#         image: mysql:5.7
#         container_name: my-db
#         restart: unless-stopped
#         command: --init-file /data/application/init.sql
#         volumes:
#             - ./initDB.sql:/data/application/init.sql
#         environment:
#             MYSQL_ROOT_PASSWORD: 123456
#             MYSQL_DATABASE: stack_overflow
#         ports:
#             - "3307:3306"
#         healthcheck:
#             # --- ĐÃ SỬA: Thêm User và Password vào lệnh ping ---
#             test:
#                 [
#                     "CMD",
#                     "mysqladmin",
#                     "ping",
#                     "-h",
#                     "localhost",
#                     "-u",
#                     "root",
#                     "-p123456",
#                 ]
#             interval: 5s
#             timeout: 3s
#             retries: 10

#     backend:
#         container_name: my-backend
#         build:
#             context: ./stackBE
#         environment:
#             # Quan trọng: HOST phải trỏ vào tên service 'mysqldb'
#             HOST: mysqldb
#             DATABASE_PORT: 3306
#             DATABASE: stack_overflow
#             USER: root
#             PASSWORD: 123456
#         ports:
#             - "8000:8000"
#         depends_on:
#             mysqldb:
#                 condition: service_healthy

#     nginx:
#         container_name: my-nginx
#         build:
#             context: .
#             dockerfile: ./nginx/Dockerfile
#         depends_on:
#             - backend
#         restart: always
#         ports:
#             # Web sẽ chạy ở cổng 8001
#             - "8001:80"
#         volumes:
#             - ./nginx/config/default.conf:/etc/nginx/conf.d/default.conf

version: "3.9"

services:
    # --- DỊCH VỤ DATABASE (MySQL) ---
    mysqldb:
        image: mysql:5.7
        container_name: my-db
        restart: unless-stopped
        # Tối ưu hóa quan trọng:
        # 1. --skip-name-resolve: Bỏ qua tra cứu DNS giúp web chạy nhanh hơn
        # 2. --default-authentication-plugin: Giúp Backend cũ kết nối được dễ dàng
        command: --init-file /data/application/init.sql --skip-name-resolve --default-authentication-plugin=mysql_native_password
        volumes:
            - ./initDB.sql:/data/application/init.sql
        environment:
            MYSQL_ROOT_PASSWORD: 123456
            MYSQL_DATABASE: stack_overflow
        ports:
            - "3307:3306" # Port 3307 để tránh trùng với MySQL trên máy thật
        healthcheck:
            # SỬA LỖI QUAN TRỌNG: Thêm user/pass vào lệnh ping để không bị Access Denied
            test:
                [
                    "CMD",
                    "mysqladmin",
                    "ping",
                    "-h",
                    "localhost",
                    "-u",
                    "root",
                    "-p123456",
                ]
            interval: 5s
            timeout: 3s
            retries: 10

    # --- DỊCH VỤ BACKEND (Node.js API) ---
    backend:
        container_name: my-backend
        build:
            context: ./stackBE
        environment:
            # QUAN TRỌNG NHẤT: Ép Node.js chạy ở cổng 8000 (mặc định nó chạy 5000 sẽ lệch với Nginx)
            PORT: 8000

            # Cấu hình kết nối Database
            HOST: mysqldb # Trỏ vào tên service MySQL (tuyệt đối không dùng localhost)
            DATABASE_PORT: 3306
            DATABASE: stack_overflow
            USER: root
            PASSWORD: 123456

            # Các biến môi trường khác (nếu có)
            # JWT_SECRET: your_secret_key
        ports:
            - "8000:8000"
        depends_on:
            mysqldb:
                condition: service_healthy # Chỉ khởi động Backend khi Database đã Healthy

    # --- DỊCH VỤ FRONTEND (Nginx + React) ---
    nginx:
        container_name: my-nginx
        build:
            context: .
            dockerfile: ./nginx/Dockerfile
        restart: always
        ports:
            - "8001:80" # Truy cập web từ Windows qua cổng 8001
        depends_on:
            - backend
        volumes:
            - ./nginx/config/default.conf:/etc/nginx/conf.d/default.conf
